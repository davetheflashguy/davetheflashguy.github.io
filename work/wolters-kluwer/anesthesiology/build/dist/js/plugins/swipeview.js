/*!
 * SwipeView v1.0 ~ Copyright (c) 2012 Matteo Spinelli, http://cubiq.org
 * Released under MIT license, http://cubiq.org/license
 */

var SwipeView=function(e,t){function b(e){return r===""?e:(e=e.charAt(0).toUpperCase()+e.substr(1),r+e)}var n=t.createElement("div").style,r=function(){var e="t,webkitT,MozT,msT,OT".split(","),t,r=0,i=e.length;for(;r<i;r++){t=e[r]+"ransform";if(t in n)return e[r].substr(0,e[r].length-1)}return!1}(),i=r?"-"+r.toLowerCase()+"-":"",s=b("transform"),o=b("transitionDuration"),u=b("perspective")in n,a="ontouchstart"in e,f=!!r,l=b("transition")in n,c=u?" translateZ(0)":"",h="onorientationchange"in e?"orientationchange":"resize",p=a?"touchstart":"mousedown",d=a?"touchmove":"mousemove",v=a?"touchend":"mouseup",m=a?"touchcancel":"mouseup",g=function(){if(r===!1)return!1;var e={"":"transitionend",webkit:"webkitTransitionEnd",Moz:"transitionend",O:"oTransitionEnd",ms:"MSTransitionEnd"};return e[r]}(),y=function(n,s){var o,u,a,f;this.wrapper=typeof n=="string"?t.querySelector(n):n,this.options={text:null,numberOfPages:3,snapThreshold:null,hastyPageFlip:!1,loop:!0};for(o in s)this.options[o]=s[o];this.wrapper.style.overflow="hidden",this.wrapper.style.position="relative",this.masterPages=[],u=t.createElement("div"),u.id="swipeview-slider",u.style.cssText="position:relative;top:0;"+i+"transition-duration:0;"+i+"transform:translateZ(0);"+i+"transition-timing-function:ease-out",this.wrapper.appendChild(u),this.slider=u,this.refreshSize();for(o=-1;o<2;o++)u=t.createElement("div"),u.id="swipeview-masterpage-"+(o+1),u.style.cssText=i+"transform:translateZ(0);position:absolute;top:0;left:"+o*100+"%",u.dataset||(u.dataset={}),f=o==-1?this.options.numberOfPages-1:o,u.dataset.pageIndex=f,u.dataset.upcomingPageIndex=f,!this.options.loop&&o==-1&&(u.style.visibility="hidden"),this.slider.appendChild(u),this.masterPages.push(u);a=this.masterPages[1].className,this.masterPages[1].className=a?a+" swipeview-active":"swipeview-active",e.addEventListener(h,this,!1),this.wrapper.addEventListener(p,this,!1),this.wrapper.addEventListener(d,this,!1),this.wrapper.addEventListener(v,this,!1),this.slider.addEventListener(g,this,!1),r=="O"&&this.slider.addEventListener(g.toLowerCase(),this,!1)};return y.prototype={currentMasterPage:1,x:0,page:0,pageIndex:0,customEvents:[],onFlip:function(e){this.wrapper.addEventListener("swipeview-flip",e,!1),this.customEvents.push(["flip",e])},onMoveOut:function(e){this.wrapper.addEventListener("swipeview-moveout",e,!1),this.customEvents.push(["moveout",e])},onMoveIn:function(e){this.wrapper.addEventListener("swipeview-movein",e,!1),this.customEvents.push(["movein",e])},onTouchStart:function(e){this.wrapper.addEventListener("swipeview-touchstart",e,!1),this.customEvents.push(["touchstart",e])},destroy:function(){while(this.customEvents.length)this.wrapper.removeEventListener("swipeview-"+this.customEvents[0][0],this.customEvents[0][1],!1),this.customEvents.shift();e.removeEventListener(h,this,!1),this.wrapper.removeEventListener(p,this,!1),this.wrapper.removeEventListener(d,this,!1),this.wrapper.removeEventListener(v,this,!1),this.slider.removeEventListener(g,this,!1)},refreshSize:function(){this.wrapperWidth=this.wrapper.clientWidth,this.wrapperHeight=this.wrapper.clientHeight,this.pageWidth=this.wrapperWidth,this.maxX=-this.options.numberOfPages*this.pageWidth+this.wrapperWidth,this.snapThreshold=this.options.snapThreshold===null?Math.round(this.pageWidth*.05):/%/.test(this.options.snapThreshold)?Math.round(this.pageWidth*this.options.snapThreshold.replace("%","")/100):this.options.snapThreshold},updatePageCount:function(e){this.options.numberOfPages=e,this.maxX=-this.options.numberOfPages*this.pageWidth+this.wrapperWidth},goToPage:function(e){var t;this.masterPages[this.currentMasterPage].className=this.masterPages[this.currentMasterPage].className.replace(/(^|\s)swipeview-active(\s|$)/,"");for(t=0;t<3;t++)className=this.masterPages[t].className,/(^|\s)swipeview-loading(\s|$)/.test(className)||(this.masterPages[t].className=className?className+" swipeview-loading":"swipeview-loading");e=e<0?0:e>this.options.numberOfPages-1?this.options.numberOfPages-1:e,this.page=e,this.pageIndex=e,this.slider.style[o]="0s",this.__pos(-e*this.pageWidth),this.currentMasterPage=this.page+1-Math.floor((this.page+1)/3)*3,this.masterPages[this.currentMasterPage].className=this.masterPages[this.currentMasterPage].className+" swipeview-active",this.currentMasterPage===0?(this.masterPages[2].style.left=this.page*100-100+"%",this.masterPages[0].style.left=this.page*100+"%",this.masterPages[1].style.left=this.page*100+100+"%",this.masterPages[2].dataset.upcomingPageIndex=this.page===0?this.options.numberOfPages-1:this.page-1,this.masterPages[0].dataset.upcomingPageIndex=this.page,this.masterPages[1].dataset.upcomingPageIndex=this.page==this.options.numberOfPages-1?0:this.page+1):this.currentMasterPage==1?(this.masterPages[0].style.left=this.page*100-100+"%",this.masterPages[1].style.left=this.page*100+"%",this.masterPages[2].style.left=this.page*100+100+"%",this.masterPages[0].dataset.upcomingPageIndex=this.page===0?this.options.numberOfPages-1:this.page-1,this.masterPages[1].dataset.upcomingPageIndex=this.page,this.masterPages[2].dataset.upcomingPageIndex=this.page==this.options.numberOfPages-1?0:this.page+1):(this.masterPages[1].style.left=this.page*100-100+"%",this.masterPages[2].style.left=this.page*100+"%",this.masterPages[0].style.left=this.page*100+100+"%",this.masterPages[1].dataset.upcomingPageIndex=this.page===0?this.options.numberOfPages-1:this.page-1,this.masterPages[2].dataset.upcomingPageIndex=this.page,this.masterPages[0].dataset.upcomingPageIndex=this.page==this.options.numberOfPages-1?0:this.page+1),this.__flip()},next:function(){if(!this.options.loop&&this.x==this.maxX)return;this.directionX=-1,this.x-=1,this.__checkPosition()},prev:function(){if(!this.options.loop&&this.x===0)return;this.directionX=1,this.x+=1,this.__checkPosition()},handleEvent:function(e){switch(e.type){case p:this.__start(e);break;case d:this.__move(e);break;case m:case v:this.__end(e);break;case h:this.__resize();break;case g:case"otransitionend":e.target==this.slider&&!this.options.hastyPageFlip&&this.__flip()}},__pos:function(e){this.x=e,this.slider.style[s]="translate("+e+"px,0)"+c},__resize:function(){this.refreshSize(),this.slider.style[o]="0s",this.__pos(-this.page*this.pageWidth)},__start:function(e){if(this.initiated)return;var t=a?e.touches[0]:e;this.initiated=!0,this.moved=!1,this.thresholdExceeded=!1,this.startX=t.pageX,this.startY=t.pageY,this.pointX=t.pageX,this.pointY=t.pageY,this.stepsX=0,this.stepsY=0,this.directionX=0,this.directionLocked=!1,this.slider.style[o]="0s",this.__event("touchstart")},__move:function(e){if(!this.initiated)return;var t=a?e.touches[0]:e,n=t.pageX-this.pointX,r=t.pageY-this.pointY,i=this.x+n,s=Math.abs(t.pageX-this.startX);this.moved=!0,this.pointX=t.pageX,this.pointY=t.pageY,this.directionX=n>0?1:n<0?-1:0,this.stepsX+=Math.abs(n),this.stepsY+=Math.abs(r);if(this.stepsX<10&&this.stepsY<10)return;if(!this.directionLocked&&this.stepsY>this.stepsX){this.initiated=!1;return}e.preventDefault(),this.directionLocked=!0,!this.options.loop&&(i>0||i<this.maxX)&&(i=this.x+n/2),!this.thresholdExceeded&&s>=this.snapThreshold?(this.thresholdExceeded=!0,this.__event("moveout")):this.thresholdExceeded&&s<this.snapThreshold&&(this.thresholdExceeded=!1,this.__event("movein")),this.__pos(i),console.log("moving"),$("#wrapper").trigger("horizontal_move_in_progress")},__end:function(e){if(!this.initiated)return;var t=a?e.changedTouches[0]:e,n=Math.abs(t.pageX-this.startX);this.initiated=!1;if(!this.moved)return;!this.options.loop&&(this.x>0||this.x<this.maxX)&&(n=0,this.__event("movein"));if(n<this.snapThreshold){this.slider.style[o]=Math.floor(300*n/this.snapThreshold)+"ms",this.__pos(-this.page*this.pageWidth);return}this.__checkPosition(),$("#wrapper").trigger("horizontal_move_complete")},__checkPosition:function(){var e,t,n;this.masterPages[this.currentMasterPage].className=this.masterPages[this.currentMasterPage].className.replace(/(^|\s)swipeview-active(\s|$)/,""),this.directionX>0?(this.page=-Math.ceil(this.x/this.pageWidth),this.currentMasterPage=this.page+1-Math.floor((this.page+1)/3)*3,this.pageIndex=this.pageIndex===0?this.options.numberOfPages-1:this.pageIndex-1,e=this.currentMasterPage-1,e=e<0?2:e,this.masterPages[e].style.left=this.page*100-100+"%",t=this.page-1,$("#wrapper").trigger("prev")):(this.page=-Math.floor(this.x/this.pageWidth),this.currentMasterPage=this.page+1-Math.floor((this.page+1)/3)*3,this.pageIndex=this.pageIndex==this.options.numberOfPages-1?0:this.pageIndex+1,e=this.currentMasterPage+1,e=e>2?0:e,this.masterPages[e].style.left=this.page*100+100+"%",t=this.page+1,$("#wrapper").trigger("next")),n=this.masterPages[this.currentMasterPage].className,/(^|\s)swipeview-active(\s|$)/.test(n)||(this.masterPages[this.currentMasterPage].className=n?n+" swipeview-active":"swipeview-active"),n=this.masterPages[e].className,/(^|\s)swipeview-loading(\s|$)/.test(n)||(this.masterPages[e].className=n?n+" swipeview-loading":"swipeview-loading"),t-=Math.floor(t/this.options.numberOfPages)*this.options.numberOfPages,this.masterPages[e].dataset.upcomingPageIndex=t,newX=-this.page*this.pageWidth,this.slider.style[o]=Math.floor(500*Math.abs(this.x-newX)/this.pageWidth)+"ms",this.options.loop||(this.masterPages[e].style.visibility=newX===0||newX==this.maxX?"hidden":""),this.x==newX?this.__flip():(this.__pos(newX),this.options.hastyPageFlip&&this.__flip())},__flip:function(){this.__event("flip");for(var e=0;e<3;e++)this.masterPages[e].className=this.masterPages[e].className.replace(/(^|\s)swipeview-loading(\s|$)/,""),this.masterPages[e].dataset.pageIndex=this.masterPages[e].dataset.upcomingPageIndex},__event:function(e){var n=t.createEvent("Event");n.initEvent("swipeview-"+e,!0,!0),this.wrapper.dispatchEvent(n)}},y}(window,document);