define(["jquery","jquerymove","jqueryswipe","underscore","backbone","views/base","models/global","fullText","toolTip","imageWrapperControl","views/signin/main","swipeview"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=s.extend({el:e("#page_container"),userToken:"3F5FCB93-EBB5-49f3-8952-7F6E4CF392B7",pdf_by_accession_number_and_user_token:null,issueAccessionNumber:null,view_web_service_url:null,verticalScrollContainer:null,position:0,initialize:function(){var e="<div id='wrapper'>";e+="<div id='view_preloader_container' style='margin-left: 10px;margin-top: 10px;'>",e+="<img src='"+this.globalModel.getEnvironment()+"images/preloader.gif' />",e+="</div>",e+="</div>",this.$el.html(e)},render:function(){function d(e){var t=e,n=t.authToken;n.length&&(userToken=n)}var t={},n=window.location.href,r=[];r=n.split("?"),r=r[1],r=r.split("&"),r=r[0].substr(23,r[0].length);var i=n.split("&");for(var s=0;s<i.length;s++){var o=i[s].split("=");if(typeof t[o[0]]=="undefined")t[o[0]]=o[1];else if(typeof t[o[0]]=="string"){var u=[t[o[0]],o[1]];t[o[0]]=u}else t[o[0]].push(o[1])}var a=r;pdf_by_accession_number_and_user_token=this.globalModel.pdf_by_accession_number_and_user_token;var f=this.globalModel.full_text_by_accession_number;f=f.replace("{accessionNumber}",a),this.view_web_service_url=f;var l=sessionStorage.getItem(t.list),c=t.index,h=JSON.parse(l);articles=h,userToken=this.userToken;var p=this;e(window).onadobedpscontextloaded=adobe.dps.store.getUserInfo(d);var v,m,s,g,y=c==0?articles.length-1:c-1,b=document.querySelectorAll("#nav li"),w=articles;e("#wrapper").on("next",function(){y==articles.length-1?y=0:y++}),e("#wrapper").on("prev",function(){y<=1?y=articles.length:y--}),v=new SwipeView("#wrapper",{numberOfPages:w.length});for(s=0;s<3;s++)m=document.createElement("div"),m.id="page_"+s,m.className="page",this.getPageMarkUp(y,this,m,v.masterPages[s]),y==articles.length-1?y=0:y++;var p=this;v.onFlip(function(){var e,t,n;for(n=0;n<3;n++){t=v.masterPages[n].dataset.upcomingPageIndex;var r=Number(t)+1;t!=v.masterPages[n].dataset.pageIndex&&(e=v.masterPages[n].querySelector("div"),p.getPageMarkUp(y,p,e))}}),v.onMoveOut(function(){v.masterPages[v.currentMasterPage].className=v.masterPages[v.currentMasterPage].className.replace(/(^|\s)swipeview-active(\s|$)/,"")}),v.onMoveIn(function(){var e=v.masterPages[v.currentMasterPage].className;/(^|\s)swipeview-active(\s|$)/.test(e)||(v.masterPages[v.currentMasterPage].className=e?e+" swipeview-active":"swipeview-active")})},getPageMarkUp:function(t,n,r,i){var s=this;this.position=t,/ * First ajax call gets the page contents */;var o=this.view_web_service_url.replace(/(accessionnumber=)[^\&]+/,"$1"+articles[t].ArticleAccessionNumber);e.ajax({url:o,async:!0}).done(function(o){var u="<div id='verticalScrollContainer"+t+"' class='verticalScrollContainer' style='height:1024px; overflow:auto'>";u+="<div id='vContent"+t+"'>",u+"<div id='contentContainer"+t+"'>";var a=e(o).find("ArticleFullTextHTML").text();a=a.replace("<![CDATA[",""),a=a.replace("]]>",""),u+=a,u+="</div>",u+="<canvas id='scrollIndicator_"+t+"' class='scrollIndicator'></canvas>",u+="</div>",u+="</div>";if(a.length>0)r.innerHTML=u;else{var f=pdf_by_accession_number_and_user_token;f=f.replace("{AccessionNumber}",articles[t].ArticleAccessionNumber),f=f.replace("{UserToken}",s.userToken),e.ajax({url:f,async:!1}).done(function(i){var s="<b>Abstract:</b>",o=articles[t].Abstract.replace("<![CDATA[","");o=o.replace("]]>","");var u;o.length>0?(o=o.replace("Introduction:","<br/>Introduction:"),o=o.replace("Background:","<br/>Background:"),o=o.replace("Methods:","<br/><br/>Methods:"),o=o.replace("Results:","<br/><br/>Results:"),o=o.replace("Conclusions:","<br/><br/>Conclusions:"),u=s+o):u="An abstract is unavailable";var a=articles[t].Authors;a=a.split(";");var f;a.length>3?f="<a style='color: #5a5a5a;text-decoration: none;' onclick=\"javascript:showReference(this, '"+articles[t].UnFormattedAuthors+"')\">"+articles[t].FormattedAuthors+"</a>":f=articles[t].Authors;var l="<div id='section_title_header_container'>";l+="<div id='section_title_header_label'>",l+=articles[t].Section,l+="</div>",l+="</div>",l+="<div id='issue_container'>",l+="<div id='issue_image_"+t+"' class='issue_image'>",l+="</div>",l+="<div id='issue_details_container'>",l+="<div id='issue_title'>",l+=articles[t].Title.truncate(),l+="</div>",l+="<div id='author_label'>"+f+"</div>",articles[t].IsCME==1&&(l+="<div id='article_links_button'>",l+="<img src='"+n.globalModel.getEnvironment()+"images/icon-cme.jpg' />",l+="</div>"),articles[t].IsOpenAccess==1&&(l+="<div id='article_links_button'>",l+="<img src='"+n.globalModel.getEnvironment()+"images/icon-open.gif' />",l+="</div>"),articles[t].IsPAP&&(l+="<div id='article_links_button'>",l+="<img src='"+n.globalModel.getEnvironment()+"'images/icon-indicator-pap.png' />",l+="</div>"),articles[t].IsSDC==1&&(l+="<div id='article_links_button'>",l+="<img src='"+n.globalModel.getEnvironment()+"images/icon-sdc.gif'>",l+="</div>");var c="";e(i).find("PdfURL").each(function(){c+="<div class='view_pdf_container'><p>This article is available in PDF only.</p><br/>",c+="<a href='"+e(this).text()+"'><div id='buy_issue_button'>View PDF</div></a></div>"}),l+=c+"<div id='abstract'>"+u+"</div></div></div><div class='clearfix'>&nbsp;</div></div></div></div>",r.innerHTML=l})}i&&i.appendChild(r),e("sup a").each(function(){e("sup a").attr("href","#_")}),e("#view_preloader_container").remove()})},removeInstance:function(){}});return h});